from pyspark.sql import SparkSession
from delta import configure_spark_with_delta_pip
from pyspark.sql.functions import count, desc
from pathlib import Path
import shutil

# 🔧 Spark + Delta config
builder = SparkSession.builder \
    .appName("Exploitation_Zone_MeteoGalicia") \
    .config("spark.sql.extensions", "io.delta.sql.DeltaSparkSessionExtension") \
    .config("spark.sql.catalog.spark_catalog", "org.apache.spark.sql.delta.catalog.DeltaCatalog")
spark = configure_spark_with_delta_pip(builder).getOrCreate()

# 📁 Rutas
base_path = Path(__file__).resolve().parents[2]
trusted_path = base_path / "data" / "trusted" / "meteogalicia_estaciones"
exploitation_path = base_path / "data" / "exploitation" / "meteogalicia_estaciones"
kpi_base_path = base_path / "data" / "exploitation" / "meteogalicia_kpis"
kpi_prov_path = kpi_base_path / "estaciones_por_provincia"
kpi_concello_path = kpi_base_path / "estaciones_por_concello"

# 🧹 Limpiar outputs anteriores
for path in [exploitation_path, kpi_prov_path, kpi_concello_path]:
    if path.exists():
        shutil.rmtree(path)

# 📥 Leer datos limpios de la zona trusted
stations_df = spark.read.format("delta").load(str(trusted_path))

# 💾 Guardar zona de explotación particionada por provincia
stations_df.write.format("delta") \
    .mode("overwrite") \
    .partitionBy("provincia") \
    .save(str(exploitation_path))

print(f"✅ Zona de explotación guardada en: {exploitation_path}")

# 📊 KPI 1: Número de estaciones por provincia
kpi_prov = stations_df.groupBy("provincia").agg(
    count("*").alias("n_estaciones")
).orderBy(desc("n_estaciones"))

# 📊 KPI 2: Número de estaciones por concello y provincia
kpi_concello = stations_df.groupBy("provincia", "concello").agg(
    count("*").alias("n_estaciones")
).orderBy("provincia", desc("n_estaciones"))

# 💾 Guardar KPIs como tablas Delta
kpi_prov.write.format("delta").mode("overwrite").save(str(kpi_prov_path))
kpi_concello.write.format("delta").mode("overwrite").save(str(kpi_concello_path))

print(f"📈 KPIs guardados en:\n- Provincias: {kpi_prov_path}\n- Concellos: {kpi_concello_path}")




